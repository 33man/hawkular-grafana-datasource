{"version":3,"sources":["../../src/query_ctrl.js"],"names":[],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\n\nexport class HawkularDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv, $q)  {\n    super($scope, $injector);\n\n    this.scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.$q = $q;\n\n    this.queryByTagCapability = false;\n    this.datasource.getCapabilities().then(caps => {\n      this.queryByTagCapability = caps.QUERY_BY_TAGS;\n    });\n\n    this.listQueryBy = [\n      {value: 'ids', text: 'Search by name'},\n      {value: 'tags', text: 'Search by tags'}\n    ];\n    this.metricTypes = [\n      {value: 'gauge', text: 'Gauge'},\n      {value: 'counter', text: 'Counter'}\n    ];\n\n    this.target.queryBy = this.target.queryBy || this.listQueryBy[0].value;\n    this.target.type = this.target.type || this.metricTypes[0].value;\n    this.target.target = this.target.target || 'select metric';\n    this.target.rate = this.target.rate === true;\n    this.target.tags = this.target.tags || [];\n\n    this.tagsSegments = _.reduce(this.target.tags, function(list, tag) {\n      list.push(uiSegmentSrv.newKey(tag.name));\n      list.push(uiSegmentSrv.newOperator(':'));\n      list.push(uiSegmentSrv.newKeyValue(tag.value));\n      list.push(uiSegmentSrv.newOperator(','));\n      return list;\n    }, []);\n    this.tagsSegments.push(uiSegmentSrv.newPlusButton());\n    this.removeTagsSegment = uiSegmentSrv.newSegment({fake: true, value: '-- Remove tag --'});\n  }\n\n  getTagsSegments(segment, $index) {\n    if (segment.type === 'plus-button') {\n      return this.$q.when([]);\n    } else if (segment.type === 'key')  {\n      return this.$q.when([angular.copy(this.removeTagsSegment)]);\n    } else if (segment.type === 'value')  {\n      var key = this.tagsSegments[$index-2].value;\n      return this.datasource.suggestTags(this.target.type, key)\n        .then(this.uiSegmentSrv.transformToSegments(false));\n    }\n  }\n\n  tagsSegmentChanged(segment, index) {\n    if (segment.value === this.removeTagsSegment.value) {\n      this.tagsSegments.splice(index, 4);\n    } else if (segment.type === 'plus-button') {\n      this.tagsSegments.splice(index, 1, this.uiSegmentSrv.newOperator(','));\n      this.tagsSegments.splice(index, 0, this.uiSegmentSrv.newKeyValue(' *'));\n      this.tagsSegments.splice(index, 0, this.uiSegmentSrv.newOperator(':'));\n      this.tagsSegments.splice(index, 0, this.uiSegmentSrv.newKey(segment.value));\n      this.tagsSegments.push(this.uiSegmentSrv.newPlusButton());\n    } else {\n      this.tagsSegments[index] = segment;\n    }\n    this.tagsToModel();\n    this.onChangeInternal();\n  }\n\n  tagsToModel() {\n    this.target.tags = [];\n    for (var i = 0; i < this.tagsSegments.length - 2; i += 4) {\n      let key = this.tagsSegments[i].value;\n      let val = this.tagsSegments[i+2].fake ? '*' : (this.tagsSegments[i+2].value || '*');\n      this.target.tags.push({name: key, value: val});\n    }\n  }\n\n  getOptions() {\n    return this.datasource.suggestQueries(this.target)\n      .then(this.uiSegmentSrv.transformToSegments(false));\n      // Options have to be transformed by uiSegmentSrv to be usable by metric-segment-model directive\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n}\n\nHawkularDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n"]}