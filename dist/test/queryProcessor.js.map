{"version":3,"sources":["../../src/queryProcessor.js"],"names":[],"mappings":"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","file":"queryProcessor.js","sourcesContent":["export class QueryProcessor {\n\n  constructor(q, backendSrv, variables, capabilities, url, baseHeaders) {\n    this.q = q;\n    this.backendSrv = backendSrv;\n    this.variables = variables;\n    this.capabilities = capabilities;\n    this.url = url;\n    this.baseHeaders = baseHeaders;\n  }\n\n  run(target, options) {\n    return this.capabilities.then(caps => {\n      if (target.queryBy === 'ids') {\n        let metricIds = this.variables.resolve(target.target, options);\n        if (caps.QUERY_POST_ENDPOINTS) {\n          return this.rawQuery(target, options.range, metricIds);\n        } else {\n          return this.rawQueryLegacy(target, options.range, metricIds);\n        }\n      } else {\n        if (target.tags.length === 0) {\n          return this.q.when([]);\n        }\n        let strTags = this.hawkularFormatTags(target.tags, options);\n        return this.rawQueryByTags(target, options.range, strTags);\n      }\n    });\n  }\n\n  hawkularFormatTags(tags, options) {\n    return tags.map(tag => {\n      var value;\n      if (tag.value === ' *') {\n        // '*' character get a special treatment in grafana so we had to use ' *' instead\n        value = '*';\n      } else {\n        value = this.variables.resolve(tag.value, options).join('|');\n      }\n      return tag.name + ':' + value;\n    }).join(',');\n  }\n\n  rawQuery(target, range, metricIds) {\n    let uri = [\n      target.type + 's',            // gauges or counters\n      target.rate ? 'rate' : 'raw', // raw or rate\n      'query'\n    ];\n    let url = this.url + '/' + uri.join('/');\n\n    return this.backendSrv.datasourceRequest({\n      url: url,\n      data: {\n        ids: metricIds,\n        start: range.from.valueOf(),\n        end: range.to.valueOf(),\n        order: 'ASC'\n      },\n      method: 'POST',\n      headers: this.baseHeaders\n    }).then(response => this.processRawResponse(target, response.status == 200 ? response.data : []));\n  }\n\n  rawQueryLegacy(target, range, metricIds) {\n    return this.q.all(metricIds.map(metric => {\n      let uri = [\n        target.type + 's',            // gauges or counters\n        encodeURIComponent(metric).replace('+', '%20'), // metric name\n        'data'];\n      let url = this.url + '/' + uri.join('/');\n\n      return this.backendSrv.datasourceRequest({\n        url: url,\n        params: {\n          start: range.from.valueOf(),\n          end: range.to.valueOf()\n        },\n        method: 'GET',\n        headers: this.baseHeaders\n      }).then(response => this.processRawResponseLegacy(target, metric, response.status == 200 ? response.data : []));\n    }));\n  }\n\n  rawQueryByTags(target, range, tags) {\n    let uri = [\n      target.type + 's',            // gauges or counters\n      target.rate ? 'rate' : 'raw', // raw or rate\n      'query'\n    ];\n    let url = this.url + '/' + uri.join('/');\n\n    return this.backendSrv.datasourceRequest({\n      url: url,\n      data: {\n        tags: tags,\n        start: range.from.valueOf(),\n        end: range.to.valueOf(),\n        order: 'ASC'\n      },\n      method: 'POST',\n      headers: this.baseHeaders\n    }).then(response => this.processRawResponse(target, response.status == 200 ? response.data : []));\n  }\n\n  processRawResponse(target, data) {\n    return data.map(timeSerie => {\n      return {\n        refId: target.refId,\n        target: timeSerie.id,\n        datapoints: timeSerie.data.map(point => [point.value, point.timestamp])\n      };\n    });\n  }\n\n  processRawResponseLegacy(target, metric, data) {\n    var datapoints;\n    if (!target.rate) {\n      datapoints = _.map(data, point => [point.value, point.timestamp]);\n    } else {\n      var sortedData = data.sort((p1, p2)=> p1.timestamp - p2.timestamp);\n      datapoints = _.chain(sortedData)\n        .zip(sortedData.slice(1))\n        .filter(pair => {\n          return pair[1] // Exclude the last pair\n            && (target.type == 'gauge' || pair[0].value <= pair[1].value); // Exclude counter resets\n        })\n        .map(pair => {\n          var point1 = pair[0], point2 = pair[1];\n          var timestamp = point2.timestamp;\n          var value_diff = point2.value - point1.value;\n          var time_diff = point2.timestamp - point1.timestamp;\n          var rate = 60000 * value_diff / time_diff;\n          return [rate, timestamp];\n        })\n        .value();\n    }\n    return {\n      refId: target.refId,\n      target: metric,\n      datapoints: datapoints\n    };\n  }\n}\n"]}