{"version":3,"sources":["../../src/datasource.js"],"names":[],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport {Aggregations} from './aggregations';\n\nexport class HawkularDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.tenant = instanceSettings.jsonData.tenant;\n    this.token = instanceSettings.jsonData.token;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.aggregations = new Aggregations();\n  }\n\n  query(options) {\n    let validTargets = options.targets\n      .filter(target => !target.hide)\n      .filter(target => target.target !== 'select metric');\n\n    if (validTargets.length === 0) {\n      return this.q.when({data: []});\n    }\n\n    let promises = validTargets.map(target =>\n      this.queryOnTarget(target, options)\n        .then(response => this.processResponse(target, response)));\n\n    return this.q.all(promises).then(responses => {\n      let flatten = [].concat.apply([], responses);\n      return {data: flatten};\n    });\n  }\n\n  queryOnTarget(target, options) {\n    let uri = [\n      target.type + 's',            // gauges or counters\n      target.rate ? 'rate' : 'raw', // raw or rate\n      'query'\n    ];\n    let url = this.url + '/' + uri.join('/');\n    let metricIds = this.resolveVariables(target.target, options.scopedVars || this.templateSrv.variables);\n\n    return this.backendSrv.datasourceRequest({\n      url: url,\n      data: {\n        ids: metricIds,\n        start: options.range.from.valueOf(),\n        end: options.range.to.valueOf()\n      },\n      method: 'POST',\n      headers: this.createHeaders()\n    }).then(response => {\n      return {\n        target: metricIds[0],\n        hawkularJson: response.status == 200 ? response.data : []\n      };\n    });\n  }\n\n  processResponse(target, response) {\n    var hawkularJson;\n    if (target.reduce === 'sum') {\n      hawkularJson = this.aggregations.on(response.hawkularJson, this.aggregations.sum);\n    } else if (target.reduce === 'average') {\n      hawkularJson = this.aggregations.on(response.hawkularJson, this.aggregations.average);\n    } else if (target.reduce === 'min') {\n      hawkularJson = this.aggregations.on(response.hawkularJson, this.aggregations.min);\n    } else if (target.reduce === 'max') {\n      hawkularJson = this.aggregations.on(response.hawkularJson, this.aggregations.max);\n    } else {\n      hawkularJson = response.hawkularJson;\n    }\n    let multipleSeries = hawkularJson.length > 1;\n    return hawkularJson.map(timeSerie => {\n      return {\n        refId: target.refId,\n        target: multipleSeries ? timeSerie.id : response.target,\n        datapoints: timeSerie.data.map(point => [point.value, point.timestamp])\n      };\n    });\n  }\n\n  createHeaders() {\n    var headers = {\n      'Content-Type': 'application/json',\n      'Hawkular-Tenant': this.tenant\n    };\n    if (typeof this.token === 'string' && this.token.length > 0) {\n      headers.Authorization = 'Bearer ' + this.token;\n    }\n    return headers;\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/status',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: options\n    }).then(result => {\n      return result.data;\n    });\n  }\n\n  metricFindQuery(options) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics',\n      params: {type: options.type},\n      method: 'GET',\n      headers: this.createHeaders()\n    }).then(result => {\n      return _.map(result.data, metric => {\n        return {text: metric.id, value: metric.id};\n      });\n    });\n  }\n\n  resolveVariables(target, scopedVars) {\n    let variables = target.match(/\\$\\w+/g);\n    var resolved = [target];\n    if (variables) {\n      variables.forEach(v => {\n        let values = this.getVarValues(v, scopedVars);\n        let newResolved = [];\n        values.forEach(val => {\n          resolved.forEach(target => {\n            newResolved.push(target.replace(v, val));\n          });\n        });\n        resolved = newResolved;\n      });\n    }\n    return resolved;\n  }\n\n  getVarValues(variable, scopedVars) {\n    let values = this.templateSrv.replace(variable, scopedVars);\n    // result might be in like \"{id1,id2,id3}\" (as string)\n    if (values.startsWith('{')) {\n        return values.substring(1, values.length-1).split(',');\n    }\n    return [values];\n  }\n}\n"]}