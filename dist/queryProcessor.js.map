{"version":3,"sources":["../src/queryProcessor.js"],"names":[],"mappings":"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","file":"queryProcessor.js","sourcesContent":["export class QueryProcessor {\n\n  constructor(q, backendSrv, variables, url, baseHeaders) {\n    this.q = q;\n    this.backendSrv = backendSrv;\n    this.variables = variables;\n    this.url = url;\n    this.baseHeaders = baseHeaders;\n  }\n\n  run(target, options) {\n    if (target.queryBy === 'ids') {\n      let metricIds = this.variables.resolve(target.target, options);\n      return this.rawQuery(target, options.range, metricIds)\n        .then(response => this.processRawResponse(target, response));\n    } else {\n      if (target.tags.length === 0) {\n        return this.q.when([]);\n      }\n      let strTags = this.hawkularFormatTags(target.tags, options);\n      return this.rawQueryByTags(target, options.range, strTags)\n        .then(response => this.processRawResponse(target, response));\n    }\n  }\n\n  hawkularFormatTags(tags, options) {\n    return tags.map(tag => {\n      var value;\n      if (tag.value === ' *') {\n        // '*' character get a special treatment in grafana so we had to use ' *' instead\n        value = '*';\n      } else {\n        value = this.variables.resolve(tag.value, options).join('|');\n      }\n      return tag.name + ':' + value;\n    }).join(',');\n  }\n\n  rawQuery(target, range, metricIds) {\n    let uri = [\n      target.type + 's',            // gauges or counters\n      target.rate ? 'rate' : 'raw', // raw or rate\n      'query'\n    ];\n    let url = this.url + '/' + uri.join('/');\n\n    return this.backendSrv.datasourceRequest({\n      url: url,\n      data: {\n        ids: metricIds,\n        start: range.from.valueOf(),\n        end: range.to.valueOf()\n      },\n      method: 'POST',\n      headers: this.baseHeaders\n    }).then(response => {\n      return response.status == 200 ? response.data : [];\n    });\n  }\n\n  rawQueryByTags(target, range, tags) {\n    let uri = [\n      target.type + 's',            // gauges or counters\n      target.rate ? 'rate' : 'raw', // raw or rate\n      'query'\n    ];\n    let url = this.url + '/' + uri.join('/');\n\n    return this.backendSrv.datasourceRequest({\n      url: url,\n      data: {\n        tags: tags,\n        start: range.from.valueOf(),\n        end: range.to.valueOf()\n      },\n      method: 'POST',\n      headers: this.baseHeaders\n    }).then(response => {\n      return response.status == 200 ? response.data : [];\n    });\n  }\n\n  processRawResponse(target, response) {\n    var datapoints = timeSerie => timeSerie.data.map(point => [point.value, point.timestamp]);\n    return response.map(timeSerie => {\n      return {\n        refId: target.refId,\n        target: timeSerie.id,\n        datapoints: datapoints(timeSerie)\n      };\n    });\n  }\n}\n"]}